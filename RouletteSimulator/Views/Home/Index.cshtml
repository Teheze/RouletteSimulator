@{
    ViewData["Title"] = "Main Page -";
}

<div class="bg-white rounded-4 bg-opacity-3 index">
    <div id="coinsDisplay">Loading coins...</div>
    <div id="countdown">Next draw in: 20 seconds</div>

    <input type="number" id="betAmount" value="10" min="1" step="1" style="margin-top: 20px;" />
    <button onclick="changeBetAmount('CLEAR')">CLEAR</button>
    <button onclick="changeBetAmount('+10')">+10</button>
    <button onclick="changeBetAmount('+100')">+100</button>
    <button onclick="changeBetAmount('+1000')">+1000</button>
    <button onclick="changeBetAmount('1/2')">1 / 2</button>
    <button onclick="changeBetAmount('X2')">X2</button>
    <button onclick="changeBetAmount('MAX')">MAX</button>
    
    <div id="lastResults" style="text-align: center; margin-top: 20px; display: flex; justify-content:space-around;">Loading last results...</div>

</div>

<div class="bg-white rounded-4 bg-opacity-3 index" style="display: flex; justify-content:space-around;">
    <button class="place-bet-button" onclick="placeBet('red')" style="background-color: red;">Bet Red</button>
    <button class="place-bet-button" onclick="placeBet('black')" style="background-color: black; color: white;">Bet Black</button>
    <button class="place-bet-button" onclick="placeBet('green')" style="background-color: greenyellow;">Bet Green</button>
</div>

<div class="bg-white rounded-4 bg-opacity-3 index" style="display: flex; justify-content:space-around;">
    <div id="betInfoRed"></div>
    <div id="betInfoBlack"></div>
    <div id="betInfoGreen"></div>
</div>
@section Scripts
{
    <script>
        async function changeBetAmount(action) {
            let currentAmount = parseInt(document.getElementById('betAmount').value);
            switch (action) {
                case 'CLEAR':
                    currentAmount = 0;
                    break;
                case '+10':
                    currentAmount += 10;
                    break;
                case '+100':
                    currentAmount += 100;
                    break;
                case '+1000':
                    currentAmount += 1000;
                    break;
                case '1/2':
                    currentAmount = Math.floor(currentAmount / 2);
                    break;
                case 'X2':
                    currentAmount *= 2;
                    break;
                case 'MAX':
                    const coins = await fetch('/api/rouletteapi/coins');
                    const maxCoins = await coins.json();
                    currentAmount = maxCoins;
                    break;
            }
            document.getElementById('betAmount').value = currentAmount;
        }

        async function fetchCoins() {
            const coinsResponse = await fetch('/api/rouletteapi/coins');
            if (coinsResponse.ok) {
                const coinsJson = await coinsResponse.json();
                document.getElementById('coinsDisplay').innerText = `Your coins: ${coinsJson}`;
            } else {
                alert("Failed to fetch coins.");
            }
        }

        async function fetchLastResults() {
            const resultsResponse = await fetch('/api/rouletteapi/last-10');
            if (resultsResponse.ok) {
                const resultsJson = await resultsResponse.json();
                let resultsHtml = '';
                resultsJson.forEach(result => {
                    resultsHtml += `<div style="background-color:${result.resultColor};
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding:5px;
                    border-radius: 50%;
                    margin:2px;
                    width:50px;
                    height:50px;">${result.result}</div>`;
                });
                document.getElementById('lastResults').innerHTML = resultsHtml;
            } else {
                alert("Failed to fetch last results.");
            }
        }

        async function placeBet(type) {
            const amount = parseInt(document.getElementById('betAmount').value);
            const bet = {
                BetType: type,
                Amount: amount,
            };

            const response = await fetch('/api/rouletteapi/bet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bet)
            });

            if (response.ok) {
                const resultJson = await response.json();
                document.getElementById('betPlaced').innerText = `Bet placed: ${type}, ${amount}`;
                await fetchCoins();
                await fetchLastResults();
                await fetchBetInfo();
            } else {
                const errorText = await response.text();
                alert(`${errorText}`);
            }
        }

        async function fetchBetInfo() {
            const response = await fetch('/api/rouletteapi/current-bets');
            if (response.ok) {
                const betData = await response.json();
                let redBetCount = 0, redTotalAmount = 0;
                let blackBetCount = 0, blackTotalAmount = 0;
                let greenBetCount = 0, greenTotalAmount = 0;

                betData.forEach(bet => {
                    if (bet.BetType === 'red') {
                        redBetCount = bet.BetCount;
                        redTotalAmount = bet.TotalAmount;
                    } else if (bet.BetType === 'black') {
                        blackBetCount = bet.BetCount;
                        blackTotalAmount = bet.TotalAmount;
                    } else if (bet.BetType === 'green') {
                        greenBetCount = bet.BetCount;
                        greenTotalAmount = bet.TotalAmount;
                    }
                });

                document.getElementById('betInfoRed').innerText = `Red: Bets = ${redBetCount}, Total = ${redTotalAmount}`;
                document.getElementById('betInfoBlack').innerText = `Black: Bets = ${blackBetCount}, Total = ${blackTotalAmount}`;
                document.getElementById('betInfoGreen').innerText = `Green: Bets = ${greenBetCount}, Total = ${greenTotalAmount}`;
            } else {
                alert('Failed to fetch bet information.');
            }
        }

        async function fetchNextDrawTime() {
            const response = await fetch('/api/rouletteapi/next-draw');
            if (response.ok) {
                const nextDrawTime = await response.json();
                return new Date(nextDrawTime);
            } else {
                alert('Failed to fetch next draw time.');
                return new Date();
            }
        }

        async function startCountdown() {
            let nextDrawTime = await fetchNextDrawTime();
            setInterval(async () => {
                const now = new Date();
                let timeRemaining = Math.floor((nextDrawTime - now) / 1000);

                if (timeRemaining <= 0) {
                    nextDrawTime = await fetchNextDrawTime();
                    timeRemaining = Math.floor((nextDrawTime - now) / 1000);
                    await fetchLastResults();
                }

                document.getElementById('countdown').innerText = `Next draw in: ${timeRemaining} seconds`;
            }, 1000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCoins();
            await fetchLastResults();
            await fetchBetInfo();
            await startCountdown();
        });
    </script>
}
